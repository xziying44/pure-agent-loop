# 动态任务列表更新设计方案

**日期**: 2026-01-30
**状态**: 已批准

## 概述

增强系统提示词，使智能体能够根据新信息动态更新任务列表，避免机械地按原计划执行。

## 问题背景

当前智能体在执行任务时，即使获得了新信息（如搜索结果揭示新线索），仍会机械地按照初始任务列表执行，导致：
- 遗漏重要的深入分析机会
- 无法根据工具失败调整策略
- 无法根据资源限制优化计划

## 设计决策

| 决策项 | 选择 | 说明 |
|--------|------|------|
| 触发机制 | LLM 自主判断 | 不修改框架逻辑，完全依赖提示词引导 |
| 更新方式 | 灵活调整 | 允许追加、修改、删除，但需说明原因 |
| 实现范围 | 纯提示词 | 仅修改 `prompts.py`，约 30 行新增 |

## 触发场景

1. **获得新信息需要深入分析**
   - 工具返回的数据揭示了新的线索或细节
   - 继续分析这些信息可能提升最终结果的准确性或完整性
   - 行动：追加新的子任务

2. **工具调用失败**
   - 某个工具返回错误或无法获取预期数据
   - 行动：删除依赖该工具的后续任务，或替换为备选方案

3. **接近资源限制**
   - 剩余步数或时间不足以完成所有计划任务
   - 行动：优先保留核心任务，删除或简化次要任务

## 调整规范

### 允许的操作
- ✅ 追加新任务（发现新线索）
- ✅ 修改任务内容（调整策略）
- ✅ 删除任务（不再需要或不可行）
- ✅ 调整任务顺序（优先级变化）

### 禁止的行为
- ❌ 无理由地删除任务
- ❌ 频繁大幅重构任务列表（每次调整应聚焦于当前发现）
- ❌ 忽略新信息，机械地按原计划执行

### 强制要求
- 在回复内容中明确说明调整原因
- 例如："搜索结果显示 XX 是关键因素，需要追加一个任务来验证"

## 修改文件

### `src/pure_agent_loop/prompts.py`

在现有的 `## 任务管理（极其重要）` 章节末尾追加两个子章节：

```markdown
### 动态调整任务列表
任务列表不是一成不变的。当以下情况发生时，你应该主动重新评估并更新任务列表：

1. **获得新信息需要深入分析**：工具返回的数据揭示了新的线索或细节，继续分析这些信息可能提升最终结果的准确性或完整性。此时应追加新的子任务。

2. **工具调用失败**：当某个工具返回错误或无法获取预期数据时，应调整策略——可能需要删除依赖该工具的后续任务，或替换为备选方案。

3. **接近资源限制**：当你意识到剩余步数或时间不足以完成所有计划任务时，应优先保留核心任务，删除或简化次要任务。

### 调整规范
更新任务列表时，必须遵守以下规范：

1. **先思考，再调整**：在回复内容中明确说明调整原因，例如："搜索结果显示 XX 是关键因素，需要追加一个任务来验证"或"API 返回 404，原计划不可行，改用备选方案"。

2. **允许的操作**：
   - ✅ 追加新任务（发现新线索）
   - ✅ 修改任务内容（调整策略）
   - ✅ 删除任务（不再需要或不可行）
   - ✅ 调整任务顺序（优先级变化）

3. **禁止的行为**：
   - ❌ 无理由地删除任务
   - ❌ 频繁大幅重构任务列表（每次调整应聚焦于当前发现）
   - ❌ 忽略新信息，机械地按原计划执行
```

## 测试验证

由于这是纯提示词修改，验证方式为：
1. 手动测试：给智能体一个需要搜索的任务，观察其是否能根据搜索结果动态调整任务列表
2. 对比测试：对比修改前后智能体在相同任务上的行为差异

## 未来扩展（暂不实现）

如需更强的可追溯性，可考虑：
- 在 `TODO_UPDATE` 事件中增加 `reason` 字段
- 让 `RichRenderer` 高亮显示任务列表的变化
